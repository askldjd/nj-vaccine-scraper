<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>NJ Vaccine Availability (Proof of Concept)</title>
    <style>
      body {
        font-family: helvetica, arial, sans-serif;
        font-size: 12px;
      }
    
      table {
        border-collapse: collapse;
        table-layout: fixed;
      }
    
      th, td {
        padding: 0.4em 0.5em;
        border: 1px solid #999;
      }
    
      th {
        background: #eee;
      }
    
      .availability.availability-no {
        background: #e8a4c8;
      }
    
      .availability.availability-yes {
        background: #a1d76a;
      }

      .availability.availability-unknown,
      .availability.availability-unknowable {
        background: #eee;
      }

      .column-url a {
        display: block;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        width: 10em;
      }
    </style>
  </head>
  <body>
    <table id="main-grid" class="waffle" cellspacing="0" cellpadding="0">

    </table>

    <script type="text/javascript">
      const UPDATE_INTERVAL = 60 * 1000;
      const DATA_URL = './data.json'

      function build (name, attributes, children) {
        const element = document.createElement(name);
        if (Array.isArray(attributes) && !children) {
          [attributes, children] = [children, attributes];
        }
        if (attributes) {
          for (let key in attributes) {
            if (key === 'className') {
              element[key] = attributes[key]
            }
            else {
              element.setAttribute(key, attributes[key]);
            }
          }
        }
        if (children) {
          for (let child of children) {
            if (child == null) continue;
            if (typeof child === 'string') {
              child = document.createTextNode(child);
            }
            element.appendChild(child);
          }
        }
        return element;
      }

      // TODO: this should come from a package that does it better.
      function timeAgo (time) {
        const delta = (Date.now() - time);
        if (delta < 60 * 1000) return '< 1 minute ago';

        const days = Math.floor(delta / (1000 * 60 * 60 * 24));
        const hours = Math.floor(delta % (1000 * 60 * 60 * 24) / (1000 * 60 * 60));
        const minutes = Math.floor(delta % (1000 * 60 * 60) / (1000 * 60));
        
        if (days) return `${days} days, ${hours} hours ago`;
        if (hours) return `${hours} hours, ${minutes} minutes ago`;
        return `${minutes} minutes ago`;
      }

      const _htmlToNodesContainer = build('template');

      function htmlToNodes (html) {
        _htmlToNodesContainer.innerHTML = html;
        Array.from(_htmlToNodesContainer.querySelectorAll('script')).forEach(n => n.remove());
        Array.from(_htmlToNodesContainer.querySelectorAll('style')).forEach(n => n.remove());
        const nodes = _htmlToNodesContainer.content;
        [].slice.call(_htmlToNodesContainer.content).forEach(n => n.remove());
        return nodes;
      }

      async function update () {
        const response = await fetch(DATA_URL);
        const data = await response.json();
        const sortValues = {
          'yes': 0,
          'unknown': 1,
          'unknowable': 1,
          'no': 2
        }
        data.sort((a, b) => sortValues[a.available] - sortValues[b.available]);
        render(data);
        setTimeout(update, UPDATE_INTERVAL);
      }

      function render (data) {
        const table = document.querySelector('#main-grid');
        const children = renderTableContent(data);
        table.innerHTML = '';
        for (let child of children) {
          table.appendChild(child);
        }
      }

      function renderTableContent (data) {
        return [...renderHeaders(), build('tbody', data.map(renderRecord))];
      }

      function renderHeaders () {
        return [
          build('colgroup', [
            build('td', {className: 'availability'}),
            build('col', {className: `column-last-update`}),
            build('col', {className: `column-name`}),
            build('col', {className: `column-address`}),
            build('col', {className: `column-county`}),
            build('col', {className: `column-age`}),
            build('col', {className: `column-phone`}),
            build('col', {className: `column-url`}),
            build('col', {className: `column-description`})
          ]),
          build('thead', [
            build('tr', [
              build('th', ['Available?']),
              build('th', ['Last Check']),
              build('th', ['Facility Name']),
              build('th', ['Facility Address']),
              build('th', ['County']),
              build('th', ['Minimum Age']),
              build('th', ['Phone']),
              build('th', ['Website']),
              build('th', ['Description'])
            ])
          ])
        ]
      }

      function renderRecord (data) {
        const availableText = {
          'yes': 'Yes',
          'no': 'No'
        }[data.available] || '?'

        let updateText = '-';
        if (data.checked_at) {
          updateText = timeAgo(new Date(data.checked_at));
        }

        let displayUrl = data.official && data.official['Facility Website'];
        if (displayUrl) {
          displayUrl = displayUrl.replace(/^https?:\/\//, '');
        }

        return build('tr', [
          build('td', {className: `availability availability-${data.available}`}, [
            availableText
          ]),
          build('td', {className: `column-last-update`}, [
            updateText
          ]),
          build('td', {className: `column-name`}, [
            data.official ? data.official['Facility Name'] : data.name
          ]),
          build('td', {className: `column-address`}, [
            data.official && data.official['Facility Address']
          ]),
          build('td', {className: `column-county`}, [
            data.official && data.official['County']
          ]),
          build('td', {className: `column-age`}, [
            data.official && data.official['Minimum Age']
          ]),
          build('td', {className: `column-phone`}, [
            data.official && data.official['Phone Number for Appointments + Questions']
          ]),
          build('td', {className: `column-url`}, [
            displayUrl
              ? build('a', {href: data.official['Facility Website']}, [displayUrl])
              : ''
          ]),
          build(
            'td',
            {className: `column-description`},
            [data.description ? htmlToNodes(data.description) : '']
          )
        ]);
      }

      update();
    </script>
  </body>
</html>
